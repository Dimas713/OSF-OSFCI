#!/bin/bash
USERNAME=$1
GITHUBREPO=$2
BRANCH=$3
BOARDS=$4
if [ ! -d /tmp/volume/$USERNAME ]
then
mkdir /tmp/volume/$USERNAME
else
rm /tmp/volume/$USERNAME/*
fi
docker run --name linuxboot_$USERNAME -v /tmp/volume/$USERNAME:/volume -e GITHUBREPO=$GITHUBREPO -e BRANCH=$BRANCH -e BOARDS=$BOARDS --rm=true  linuxboot >& $PIPE_PATH/bios_fifo
if [ -f /tmp/volume/$USERNAME/linuxboot.bin ]
then
cp /tmp/volume/$USERNAME/linuxboot.bin $FIRMWARES_PATH/linuxboot_$USERNAME.bin
echo "Image successfully generated ..." > $PIPE_PATH/bios_fifo
echo "Injecting the linux kernel to a BIOS image ..." > $PIPE_PATH/bios_fifo
echo "$BINARIES_PATH/utk $FIRMWARES_PATH/default.rom replace_pe32 Shell linuxboot_$USERNAME.bin save test_$USERNAME.rom" > $PIPE_PATH/bios_fifo
$BINARIES_PATH/utk $FIRMWARES_PATH/default.rom replace_pe32 Shell linuxboot_$USERNAME.bin save $FIRMWARES_PATH/test_$USERNAME.rom
echo "$BINARIES_PATH/shadow test_$USERNAME.rom" > $PIPE_PATH/bios_fifo
$BINARIES_PATH/shadow $FIRMWARES_PATH/test_$USERNAME.rom
exit 0
fi
